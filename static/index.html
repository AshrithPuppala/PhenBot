<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PhenBOT - App</title>
<style>
/* compacted CSS for SPA; main global CSS sits in static/style.css */
:root{--accent:#4facfe;--secondary:#667eea;--card:#fff;--muted:#64748b}
*{box-sizing:border-box}body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;color:#111}
.app-container{display:flex;height:100vh;overflow:hidden}
.sidebar{width:280px;background:var(--card);border-right:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column}
.sidebar-header{padding:20px;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white}
.logo{font-weight:700;font-size:20px}
.tagline{font-size:12px;opacity:0.9}
.nav-tabs{padding:12px 0;flex:1;overflow:auto}
.nav-tab{display:flex;align-items:center;padding:12px 20px;color:var(--muted);border-left:3px solid transparent;cursor:pointer}
.nav-tab.active{background:rgba(79,172,254,0.08);color:var(--accent);border-left-color:var(--accent)}
.streak-section{padding:18px;margin:16px;border-radius:12px;background:linear-gradient(135deg,#fef3c7,#fbbf24);text-align:center}
.streak-counter{font-size:28px;font-weight:700;color:#92400e}

/* main */
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.top-bar{background:var(--card);padding:12px 20px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between}
.system-status{padding:6px 12px;border-radius:20px;font-weight:600}
.system-status.online{background:#10b981;color:white}
.system-status.offline{background:#ef4444;color:white}
.user-info{display:flex;gap:12px;align-items:center}
.accuracy-meter,.pomodoro-timer{padding:8px 12px;border-radius:20px;font-weight:600;color:white}
.accuracy-meter{background:#10b981}
.pomodoro-timer{background:#f59e0b}

/* content */
.content-area{padding:20px;overflow:auto;flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.04), rgba(255,255,255,0));}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px}
.dashboard-card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
.card-title{font-weight:600;margin-bottom:8px}

/* chat */
.chat-container{display:flex;flex-direction:column;height:60vh;border-radius:12px;overflow:hidden}
.chat-messages{flex:1;padding:12px;overflow:auto;background:#f8fafc}
.message{display:flex;gap:12px;align-items:flex-start;margin-bottom:12px}
.message.user{flex-direction:row-reverse}
.message-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
.message.bot .message-avatar{background:linear-gradient(135deg,#4facfe,#00f2fe);color:white}
.message.user .message-avatar{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.message-content{padding:12px;border-radius:12px;max-width:75%}
.message.bot .message-content{background:#fff;color:#111}
.message.user .message-content{background:var(--accent);color:white}

/* input */
.chat-input-area{padding:12px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:12px;align-items:flex-end}
.message-input{flex:1;padding:12px;border-radius:20px;border:2px solid rgba(0,0,0,0.06);min-height:48px;resize:none}

/* pdf + flashcards + bookmarks */
.pdf-upload{display:flex;gap:8px;align-items:center}
.pdf-list{margin-top:10px;display:flex;flex-direction:column;gap:10px}
.pdf-item{background:#fff;padding:10px;border-radius:8px;display:flex;justify-content:space-between}

/* small */
.small{font-size:13px;color:#6b7280}
.tool-btn{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>
<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">ü§ñ PhenBOT</div>
      <div class="tagline">Advanced Study Companion</div>
    </div>

    <nav class="nav-tabs">
      <div class="nav-tab active" data-tab="dashboard">üìä Dashboard</div>
      <div class="nav-tab" data-tab="math">üî¢ Mathematics</div>
      <div class="nav-tab" data-tab="science">üî¨ Science</div>
      <div class="nav-tab" data-tab="english">üìö English</div>
      <div class="nav-tab" data-tab="history">üèõ History</div>
      <div class="nav-tab" data-tab="tools">üõ† Tools</div>
    </nav>

    <div class="streak-section">
      <div class="streak-counter" id="streakCounter">7</div>
      <div class="small">Day Streak üî•</div>
    </div>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div id="systemStatus" class="system-status offline">Checking...</div>
      <div class="user-info">
        <div class="accuracy-meter" id="accuracyMeter">Accuracy: 92%</div>
        <div class="pomodoro-timer" id="pomWrap">
          <span id="pomLabel">üçÖ</span> <strong id="pomTime">25:00</strong>
          <button id="pomStart" class="tool-btn" style="margin-left:10px;padding:6px 8px">Start</button>
          <button id="pomPause" class="tool-btn" style="background:#f3f4f6;color:#111;padding:6px 8px">Pause</button>
          <button id="pomReset" class="tool-btn" style="background:#ef4444">Reset</button>
        </div>
      </div>
    </div>

    <div class="content-area">
      <!-- Dashboard -->
      <div class="tab-content active" id="dashboard">
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="card-title">Today's Progress</div>
            <div class="small">School goals, streaks, badges</div>
          </div>

          <div class="dashboard-card">
            <div class="card-title">Recent Activity</div>
            <ul id="recentActivity">
              <li>‚úÖ System initialized</li>
            </ul>
          </div>

          <div class="dashboard-card">
            <div class="card-title">AI Status</div>
            <div id="aiStatusDetails"><div id="groqStatus" class="small">Checking AI connection...</div><div id="apiKeyStatus" class="small"></div></div>
          </div>
        </div>
      </div>

      <!-- Chat tabs -->
      <div class="tab-content" id="math">
        <div class="chat-container">
          <div class="chat-messages" id="mathMessages">
            <div class="message bot"><div class="message-avatar">ü§ñ</div><div class="message-content">Ask me math questions.</div></div>
          </div>
          <div class="chat-input-area">
            <textarea class="message-input" data-subject="math" placeholder="Ask a math question..."></textarea>
            <button class="tool-btn send-button">‚û§</button>
          </div>
        </div>
      </div>

      <div class="tab-content" id="science">
        <div class="chat-container">
          <div class="chat-messages" id="scienceMessages">
            <div class="message bot"><div class="message-avatar">ü§ñ</div><div class="message-content">Ask me science questions.</div></div>
          </div>
          <div class="chat-input-area">
            <textarea class="message-input" data-subject="science" placeholder="Ask a science question..."></textarea>
            <button class="tool-btn send-button">‚û§</button>
          </div>
        </div>
      </div>

      <div class="tab-content" id="english">
        <div class="chat-container">
          <div class="chat-messages" id="englishMessages">
            <div class="message bot"><div class="message-avatar">ü§ñ</div><div class="message-content">Ask about English & literature.</div></div>
          </div>
          <div class="chat-input-area">
            <textarea class="message-input" data-subject="english" placeholder="Ask about English..."></textarea>
            <button class="tool-btn send-button">‚û§</button>
          </div>
        </div>
      </div>

      <div class="tab-content" id="history">
        <div class="chat-container">
          <div class="chat-messages" id="historyMessages">
            <div class="message bot"><div class="message-avatar">ü§ñ</div><div class="message-content">Welcome to History.</div></div>
          </div>
          <div class="chat-input-area">
            <textarea class="message-input" data-subject="history" placeholder="Ask about history..."></textarea>
            <button class="tool-btn send-button">‚û§</button>
          </div>
        </div>
      </div>

      <!-- Tools: PDF upload, flashcards, bookmarks -->
      <div class="tab-content" id="tools">
        <div class="dashboard-card">
          <div class="card-title">Upload PDF</div>
          <div class="pdf-upload">
            <input type="file" id="pdfFile" accept="application/pdf" />
            <button id="uploadPdfBtn" class="tool-btn">Upload</button>
            <span id="uploadStatus" class="small"></span>
          </div>
          <div id="pdfList" class="pdf-list"></div>

          <hr style="margin:12px 0" />

          <div class="card-title">Flashcards</div>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="fcQuestion" placeholder="Question" style="flex:1;padding:8px;border-radius:8px" />
            <input id="fcAnswer" placeholder="Answer" style="flex:1;padding:8px;border-radius:8px" />
            <button id="addFlashcardBtn" class="tool-btn">Add</button>
          </div>
          <div id="flashcardsList"></div>

          <hr style="margin:12px 0" />

          <div class="card-title">Bookmarks</div>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="bmTitle" placeholder="Title" style="flex:1;padding:8px;border-radius:8px" />
            <input id="bmUrl" placeholder="https://..." style="flex:1;padding:8px;border-radius:8px" />
            <button id="addBMBtn" class="tool-btn">Add</button>
          </div>
          <div id="bmList"></div>

          <hr style="margin:12px 0" />

          <div class="card-title">AI History</div>
          <div id="historyList" class="small"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(async function(){
  // Auth check: the /app route already restricts access; double-check current user
  try {
    const me = await fetch('/api/me', { credentials: 'same-origin' });
    if (!me.ok) {
      // not authenticated - redirect to login
      window.location.href = '/login';
      return;
    }
  } catch (e) {
    console.error('Auth check failed', e);
    window.location.href = '/login';
    return;
  }

  // Tab switching
  const navTabs = document.querySelectorAll('.nav-tab');
  const tabContents = document.querySelectorAll('.tab-content');
  navTabs.forEach(tab => tab.addEventListener('click', ()=> {
    navTabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const name = tab.dataset.tab;
    tabContents.forEach(c=>c.classList.remove('active'));
    document.getElementById(name).classList.add('active');
  }));

  // System health
  const systemStatusEl = document.getElementById('systemStatus');
  async function updateHealth(){
    try {
      systemStatusEl.textContent = 'Checking...';
      const res = await fetch('/health', { credentials: 'same-origin' });
      if (!res.ok) { systemStatusEl.textContent = 'Health check failed'; return; }
      const d = await res.json();
      if (d.groq_available) {
        systemStatusEl.textContent = 'Online';
        systemStatusEl.classList.remove('offline'); systemStatusEl.classList.add('online');
        document.getElementById('groqStatus').textContent = 'AI connected';
        document.getElementById('apiKeyStatus').textContent = d.api_key_present ? 'API Key present' : 'API Key missing';
      } else {
        systemStatusEl.textContent = 'AI unavailable';
        systemStatusEl.classList.remove('online'); systemStatusEl.classList.add('offline');
        document.getElementById('groqStatus').textContent = d.error || 'AI not available';
        document.getElementById('apiKeyStatus').textContent = d.api_key_present ? 'API Key present' : 'API Key missing';
      }
    } catch(e) {
      console.error(e);
      systemStatusEl.textContent = 'Error';
      systemStatusEl.classList.remove('online'); systemStatusEl.classList.add('offline');
    }
  }
  updateHealth();
  setInterval(updateHealth, 15000);

  // Chat send
  function createMessageEl(text, role='user') {
    const msg = document.createElement('div'); msg.className = 'message ' + role;
    const avatar = document.createElement('div'); avatar.className = 'message-avatar';
    avatar.textContent = role === 'user' ? 'A' : 'ü§ñ';
    const content = document.createElement('div'); content.className = 'message-content'; content.textContent = text;
    msg.appendChild(avatar); msg.appendChild(content); return msg;
  }

  async function sendQuestion(question, subject, chatMessagesEl) {
    const userMsg = createMessageEl(question, 'user'); chatMessagesEl.appendChild(userMsg); chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    const botPlaceholder = createMessageEl('Thinking...', 'bot'); botPlaceholder.classList.add('loading'); chatMessagesEl.appendChild(botPlaceholder); chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

    try {
      const res = await fetch('/api/ask', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, subject })
      });
      const data = await res.json();
      botPlaceholder.classList.remove('loading');
      if (!res.ok) {
        botPlaceholder.querySelector('.message-content').textContent = 'Error: ' + (data.error || res.statusText);
        return;
      }
      botPlaceholder.querySelector('.message-content').textContent = data.answer || 'No answer';
      // refresh history
      loadHistory();
    } catch (e) {
      botPlaceholder.classList.remove('loading');
      botPlaceholder.querySelector('.message-content').textContent = 'Network error: ' + e.message;
    } finally { chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; }
  }

  // Wire send buttons per chat tab
  document.querySelectorAll('.tab-content').forEach(tab => {
    const sendBtn = tab.querySelector('.send-button');
    const textarea = tab.querySelector('.message-input');
    const chatMessages = tab.querySelector('.chat-messages');
    if (sendBtn && textarea && chatMessages) {
      sendBtn.addEventListener('click', ()=> {
        const q = textarea.value.trim(); if (!q) return;
        const subject = textarea.dataset.subject || tab.id || 'general'; textarea.value=''; sendQuestion(q, subject, chatMessages);
      });
      textarea.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});
    }
  });

  // ---------- Pomodoro (client only) ----------
  const pomTimeEl = document.getElementById('pomTime');
  const pomStart = document.getElementById('pomStart');
  const pomPause = document.getElementById('pomPause');
  const pomReset = document.getElementById('pomReset');
  const DEFAULT = 25*60;
  let seconds = DEFAULT;
  let timer = null;
  let running = false;
  function loadPom(){
    try {
      const raw = localStorage.getItem('phenbot_pom');
      if (raw) {
        const obj = JSON.parse(raw);
        seconds = typeof obj.seconds === 'number' ? obj.seconds : DEFAULT;
        running = !!obj.running;
      }
    } catch(e){}
    updatePom();
    if (running) startPom();
  }
  function savePom(){ localStorage.setItem('phenbot_pom', JSON.stringify({ seconds, running })); }
  function formatTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const sec=(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }
  function updatePom(){ pomTimeEl.textContent = formatTime(seconds); }
  function tick(){ if (seconds>0){ seconds--; updatePom(); savePom(); } else { pausePom(); alert('Pomodoro finished!'); } }
  function startPom(){ if (running) return; running=true; timer = setInterval(tick,1000); savePom(); }
  function pausePom(){ running=false; if (timer) clearInterval(timer); timer=null; savePom(); }
  function resetPom(){ pausePom(); seconds = DEFAULT; updatePom(); savePom(); }
  pomStart.addEventListener('click', startPom); pomPause.addEventListener('click', pausePom); pomReset.addEventListener('click', resetPom);
  loadPom();

  // ---------- PDF upload/list ----------
  const pdfInput = document.getElementById('pdfFile');
  const uploadBtn = document.getElementById('uploadPdfBtn');
  const uploadStatus = document.getElementById('uploadStatus');
  const pdfListEl = document.getElementById('pdfList');

  async function fetchPdfList(){
    pdfListEl.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/pdfs', { credentials: 'same-origin' });
      const d = await res.json();
      pdfListEl.innerHTML = '';
      if (d.files && d.files.length){
        d.files.forEach(f => {
          const div = document.createElement('div'); div.className = 'pdf-item';
          const left = document.createElement('div'); left.textContent = f.name;
          const right = document.createElement('div'); const a = document.createElement('a'); a.href = f.url; a.target = '_blank'; a.textContent = 'Preview';
          right.appendChild(a); div.appendChild(left); div.appendChild(right); pdfListEl.appendChild(div);
        });
      } else { pdfListEl.innerHTML = '<div class="small">No PDFs uploaded yet.</div>'; }
    } catch(e){ pdfListEl.innerHTML = '<div class="small">Error loading PDFs</div>'; }
  }

  uploadBtn.addEventListener('click', async ()=> {
    uploadStatus.textContent = '';
    if (!pdfInput.files || pdfInput.files.length === 0) { uploadStatus.textContent = 'Select a PDF.'; return; }
    const file = pdfInput.files[0];
    if (file.type !== 'application/pdf') { uploadStatus.textContent = 'Only PDF allowed.'; return; }
    const form = new FormData(); form.append('file', file);
    uploadBtn.disabled = true; uploadStatus.textContent = 'Uploading...';
    try {
      const res = await fetch('/api/upload-pdf', { method:'POST', body: form, credentials:'same-origin' });
      const d = await res.json();
      uploadBtn.disabled = false;
      if (res.status === 201) { uploadStatus.textContent = 'Uploaded ‚úî'; pdfInput.value=''; fetchPdfList(); }
      else { uploadStatus.textContent = 'Upload failed: ' + (d.error||res.statusText); }
    } catch(e){ uploadBtn.disabled=false; uploadStatus.textContent = 'Network error'; }
  });

  fetchPdfList();

  // ---------- Flashcards ----------
  const fcQ = document.getElementById('fcQuestion'), fcA = document.getElementById('fcAnswer'), addFcBtn = document.getElementById('addFlashcardBtn'), fcListEl = document.getElementById('flashcardsList');
  let flashcards = [];
  async function loadFlashcards(){
    fcListEl.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/flashcards', { credentials:'same-origin' });
      const d = await res.json();
      flashcards = d.flashcards || [];
      renderFlashcards();
    } catch(e){ fcListEl.innerHTML = 'Error loading flashcards'; }
  }
  function renderFlashcards(){
    fcListEl.innerHTML = '';
    if (!flashcards.length) { fcListEl.innerHTML = '<div class="small">No flashcards yet.</div>'; return; }
    flashcards.forEach(card => {
      const div = document.createElement('div'); div.className='pdf-item';
      const left = document.createElement('div'); left.innerHTML = `<strong>Q:</strong> ${card.question}<br/><small><strong>A:</strong> ${card.answer}</small>`;
      const right = document.createElement('div'); const del = document.createElement('button'); del.textContent='Delete'; del.className='tool-btn'; del.style.background='#ef4444';
      del.addEventListener('click', ()=> deleteFlashcard(card.id));
      right.appendChild(del); div.appendChild(left); div.appendChild(right); fcListEl.appendChild(div);
    });
  }
  addFcBtn.addEventListener('click', async ()=> {
    const q = fcQ.value.trim(), a = fcA.value.trim(); if (!q||!a){ alert('Both required'); return; }
    addFcBtn.disabled = true;
    try {
      const res = await fetch('/api/flashcards', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question:q,answer:a})});
      const d = await res.json(); addFcBtn.disabled=false;
      if (res.status===201){ flashcards.unshift(d.flashcard); fcQ.value=''; fcA.value=''; renderFlashcards(); }
      else { alert('Error: '+(d.error||res.statusText)); }
    } catch(e){ addFcBtn.disabled=false; alert('Network error'); }
  });
  async function deleteFlashcard(id){
    if (!confirm('Delete this flashcard?')) return;
    try {
      const res = await fetch('/api/flashcards/'+encodeURIComponent(id), { method:'DELETE', credentials:'same-origin' });
      if (res.ok) { flashcards = flashcards.filter(c=>c.id!==id); renderFlashcards(); }
      else { const d = await res.json().catch(()=>({})); alert('Delete failed: '+(d.error||res.statusText)); }
    } catch(e){ alert('Network error'); }
  }
  loadFlashcards();

  // ---------- Bookmarks ----------
  const bmTitle = document.getElementById('bmTitle'), bmUrl = document.getElementById('bmUrl'), addBMBtn = document.getElementById('addBMBtn'), bmList = document.getElementById('bmList');
  let bookmarks = [];
  async function loadBookmarks(){
    bmList.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/bookmarks', { credentials:'same-origin' });
      const d = await res.json(); bookmarks = d.bookmarks || [];
      renderBookmarks();
    } catch(e){ bmList.innerHTML = 'Error'; }
  }
  function renderBookmarks(){
    bmList.innerHTML = '';
    if (!bookmarks.length){ bmList.innerHTML = '<div class="small">No bookmarks yet.</div>'; return; }
    bookmarks.forEach(b=>{
      const div = document.createElement('div'); div.className='pdf-item';
      const left = document.createElement('div'); left.innerHTML = `<a href="${b.url}" target="_blank">${b.title}</a>`;
      const right = document.createElement('div'); const del = document.createElement('button'); del.textContent='Delete'; del.className='tool-btn'; del.style.background='#ef4444';
      del.addEventListener('click', ()=> deleteBookmark(b.id));
      right.appendChild(del); div.appendChild(left); div.appendChild(right); bmList.appendChild(div);
    });
  }
  addBMBtn.addEventListener('click', async ()=>{
    const title = bmTitle.value.trim(), url = bmUrl.value.trim();
    if (!title||!url){ alert('Title and URL required'); return; }
    addBMBtn.disabled = true;
    try {
      const res = await fetch('/api/bookmarks', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title,url})});
      const d = await res.json(); addBMBtn.disabled=false;
      if (res.status===201){ bookmarks.unshift(d.bookmark); bmTitle.value=''; bmUrl.value=''; renderBookmarks(); } else { alert('Error: '+(d.error||res.statusText)); }
    } catch(e){ addBMBtn.disabled=false; alert('Network error'); }
  });
  async function deleteBookmark(id){
    if (!confirm('Delete this bookmark?')) return;
    try {
      const res = await fetch('/api/bookmarks/'+encodeURIComponent(id), { method:'DELETE', credentials:'same-origin' });
      if (res.ok) { bookmarks = bookmarks.filter(b=>b.id!==id); renderBookmarks(); } else { const d=await res.json().catch(()=>({})); alert('Delete failed: '+(d.error||res.statusText)); }
    } catch(e){ alert('Network error'); }
  }
  loadBookmarks();

  // ---------- History (AI Q/A) ----------
  const historyList = document.getElementById('historyList');
  async function loadHistory(){
    historyList.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/history', { credentials:'same-origin' });
      const d = await res.json();
      historyList.innerHTML = '';
      if (d.history && d.history.length){
        d.history.forEach(h => {
          const div = document.createElement('div'); div.style.marginBottom='8px';
          div.innerHTML = `<strong>${h.subject}</strong> ‚Äî <small>${(new Date(h.created_at)).toLocaleString()}</small><div style="margin-top:4px">${h.question}</div><div style="margin-top:6px;color:#374151">${h.answer}</div>`;
          historyList.appendChild(div);
        });
      } else historyList.innerHTML = '<div class="small">No history yet.</div>';
    } catch(e){ historyList.innerHTML = 'Error loading history'; }
  }
  loadHistory();

})();
</script>
</body>
</html>
