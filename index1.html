from flask import Flask, request, jsonify, send_from_directory, send_file
from groq import Groq
import os

app = Flask(__name__)

# Get API key from environment
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
groq_client = Groq(api_key=GROQ_API_KEY) if GROQ_API_KEY else None

@app.route('/')
def serve_index():
    try:
        # Try to serve index1.html if it exists
        return send_file('index1.html')
    except FileNotFoundError:
        # Fallback to a simple response
        return '''
        <html>
        <body>
        <h1>PhenBOT Study Companion</h1>
        <p>HTML file not found. Please make sure index1.html is in the root directory.</p>
        </body>
        </html>
        ''', 404

@app.route('/api/ask', methods=['POST'])
def api_ask():
    try:
        data = request.get_json()
        if not data:
            return jsonify({'error': 'No JSON data provided'}), 400
            
        question = data.get('question', '').strip()
        
        if not question:
            return jsonify({'answer': 'Please enter a question.'})

        if not groq_client:
            return jsonify({'error': 'API configuration error. Please check server logs.'})

        # Create a more specific prompt
        prompt = f"""You are PhenBOT, a helpful academic study companion. Provide clear, educational answers to student questions.

Question: {question}

Please provide a comprehensive but concise answer that helps the student understand the topic."""

        response = groq_client.chat.completions.create(
            messages=[{"role": "user", "content": prompt}],
            model="llama-3.1-8b-instant",
            temperature=0.7,
            max_tokens=500
        )
        
        answer = response.choices[0].message.content
        return jsonify({'answer': answer})
        
    except Exception as e:
        print(f"Error in api_ask: {str(e)}")
        return jsonify({'error': f'Sorry, I encountered an error: {str(e)}'}), 500

# Health check endpoint
@app.route('/health')
def health():
    return jsonify({'status': 'healthy', 'groq_configured': groq_client is not None})

# Serve any other static files
@app.route('/<path:filename>')
def serve_static(filename):
    try:
        return send_file(filename)
    except FileNotFoundError:
        return "File not found", 404

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    debug = os.environ.get('FLASK_DEBUG', 'False').lower() == 'true'
    app.run(host='0.0.0.0', port=port, debug=debug)
